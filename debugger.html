<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Completo Sistema Unit√†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .test-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #005a87; }
        .btn-success { background: #28a745; }
        .btn-danger { background: #dc3545; }
        .log { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .status { padding: 5px 10px; border-radius: 3px; font-weight: bold; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Test Completo Sistema Unit√†</h1>
            <p>URL: <code id="currentUrl">https://script.google.com/macros/s/AKfycbyaP_Q2vAWxHaJyJRtyOh5pE_7PzpNZtmfVX-uQrmBJa7v_Jhg3RNa2s025dqE01V1Q/exec</code></p>
        </div>

        <!-- Test Automatico -->
        <div class="test-section">
            <h3>üöÄ Test Automatico Completo</h3>
            <button class="btn" onclick="runFullTest()">Esegui Test Completo</button>
            <div class="log" id="fullTestLog"></div>
        </div>

        <!-- Test Singoli -->
        <div class="test-section">
            <h3>üîç Test Singoli</h3>
            <button class="btn" onclick="testGetUnits()">Test GET Unit√†</button>
            <button class="btn" onclick="testGetOrdini()">Test GET Ordini</button>
            <button class="btn btn-success" onclick="testRegistration()">Test Registrazione</button>
            <div class="log" id="singleTestLog"></div>
        </div>

        <!-- Risultati -->
        <div class="test-section">
            <h3>üìä Risultati</h3>
            <div id="results">
                <p>Esegui i test per vedere i risultati...</p>
            </div>
        </div>

        <!-- Dettagli API -->
        <div class="test-section">
            <h3>üîß Dettagli Tecnico</h3>
            <div id="apiDetails">
                <p>In attesa di test...</p>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyaP_Q2vAWxHaJyJRtyOh5pE_7PzpNZtmfVX-uQrmBJa7v_Jhg3RNa2s025dqE01V1Q/exec';
        
        const fullTestLog = document.getElementById('fullTestLog');
        const singleTestLog = document.getElementById('singleTestLog');
        const resultsDiv = document.getElementById('results');
        const apiDetails = document.getElementById('apiDetails');

        function logTo(element, message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            element.innerHTML += `<div class="${color}">[${time}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function clearLog(element) {
            element.innerHTML = '';
        }

        async function runFullTest() {
            clearLog(fullTestLog);
            resultsDiv.innerHTML = '<p>Test in corso...</p>';
            apiDetails.innerHTML = '<p>Analisi in corso...</p>';

            const tests = [
                { name: 'Connessione API Base', fn: testConnection },
                { name: 'GET Fogli Unit√†', fn: testGetUnits },
                { name: 'GET Fogli Ordini', fn: testGetOrdini },
                { name: 'POST Registrazione Unit√†', fn: testRegistration }
            ];

            let passed = 0;
            let failed = 0;
            const testResults = [];

            for (const test of tests) {
                logTo(fullTestLog, `üîç Eseguendo: ${test.name}...`);
                
                try {
                    const result = await test.fn();
                    testResults.push({ name: test.name, success: true, data: result });
                    
                    logTo(fullTestLog, `‚úÖ ${test.name} - SUCCESSO`, 'success');
                    passed++;
                } catch (error) {
                    testResults.push({ name: test.name, success: false, error: error.message });
                    
                    logTo(fullTestLog, `‚ùå ${test.name} - ERRORE: ${error.message}`, 'error');
                    failed++;
                }
                
                // Pausa tra i test
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            // Mostra risultati finali
            showFinalResults(passed, failed, tests.length, testResults);
            
            // Mostra dettagli tecnici
            showApiDetails(testResults);
        }

        async function testConnection() {
            try {
                const response = await fetch(API_URL + '?sheet=Unit√†');
                if (!response.ok) throw new Error(`HTTP ${response.status} - ${response.statusText}`);
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error(`Content-Type non JSON: ${contentType}`);
                }
                
                return {
                    status: response.status,
                    contentType: contentType,
                    headers: Object.fromEntries(response.headers.entries())
                };
            } catch (error) {
                throw new Error(`Connessione fallita: ${error.message}`);
            }
        }

        async function testGetUnits() {
            try {
                const response = await fetch(API_URL + '?sheet=Unit√†');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error('I dati non sono un array');
                }
                
                return {
                    rowCount: data.length,
                    headers: data[0] || [],
                    sample: data.slice(0, 3) // Prime 3 righe
                };
            } catch (error) {
                throw new Error(`GET Unit√† fallito: ${error.message}`);
            }
        }

        async function testGetOrdini() {
            try {
                const response = await fetch(API_URL + '?sheet=Ordini');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                return {
                    rowCount: data.length,
                    headers: data[0] || [],
                    sample: data.slice(0, 3)
                };
            } catch (error) {
                throw new Error(`GET Ordini fallito: ${error.message}`);
            }
        }

        async function testRegistration() {
            const testData = {
                matricola: 'TEST-' + Math.floor(Math.random() * 10000),
                nick: 'test_user_' + Date.now(),
                tipo: 'Fanteria',
                movimento: 2,
                visione: 1,
                armatura: 1,
                rifornimenti: 3,
                componenti: 'Fucile di Test | Range 3 | 2 danni',
                password: 'test123'
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'register',
                        data: testData
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error('Risposta API non success');
                }
                
                return {
                    request: testData,
                    response: result
                };
            } catch (error) {
                throw new Error(`Registrazione fallita: ${error.message}`);
            }
        }

        function showFinalResults(passed, failed, total, testResults) {
            const successRate = Math.round((passed / total) * 100);
            
            resultsDiv.innerHTML = `
                <h4>üìà Risultati Finali</h4>
                <p><strong>Test Passati:</strong> <span class="status status-success">${passed} ‚úÖ</span></p>
                <p><strong>Test Falliti:</strong> <span class="status status-error">${failed} ‚ùå</span></p>
                <p><strong>Totale Test:</strong> ${total}</p>
                <p><strong>Success Rate:</strong> ${successRate}%</p>
                
                ${failed === 0 ? 
                    '<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin-top: 10px;">üéâ <strong>Tutto funziona correttamente!</strong> Il sistema √® pronto per l\'uso.</div>' : 
                    '<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-top: 10px;">‚ö†Ô∏è <strong>Alcuni test hanno fallito.</strong> Controlla i log per i dettagli.</div>'
                }
            `;
        }

        function showApiDetails(testResults) {
            let detailsHtml = '<h4>Dettagli Connessione:</h4>';
            
            testResults.forEach(test => {
                detailsHtml += `
                    <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <strong>${test.name}:</strong> 
                        <span class="${test.success ? 'success' : 'error'}">${test.success ? '‚úÖ SUCCESSO' : '‚ùå FALLITO'}</span>
                        ${test.error ? `<br><small>Errore: ${test.error}</small>` : ''}
                    </div>
                `;
            });

            // Aggiungi informazioni sull'URL
            detailsHtml += `
                <div style="margin-top: 15px; padding: 10px; background: #e9ecef; border-radius: 5px;">
                    <strong>URL API:</strong><br>
                    <code>${API_URL}</code><br>
                    <small>Endpoint testati: ?sheet=Unit√†, ?sheet=Ordini, POST /</small>
                </div>
            `;

            apiDetails.innerHTML = detailsHtml;
        }

        // Test singoli per debugging
        async function testGetUnits() {
            clearLog(singleTestLog);
            try {
                const result = await testGetUnits();
                logTo(singleTestLog, `‚úÖ GET Unit√† - SUCCESSO`, 'success');
                logTo(singleTestLog, `üìä Righe: ${result.rowCount}`, 'success');
                logTo(singleTestLog, `üìã Intestazioni: ${JSON.stringify(result.headers)}`, 'success');
                logTo(singleTestLog, `üéØ Anteprima: ${JSON.stringify(result.sample)}`, 'success');
                return true;
            } catch (error) {
                logTo(singleTestLog, `‚ùå GET Unit√† - ERRORE: ${error.message}`, 'error');
                return false;
            }
        }

        async function testGetOrdini() {
            clearLog(singleTestLog);
            try {
                const result = await testGetOrdini();
                logTo(singleTestLog, `‚úÖ GET Ordini - SUCCESSO`, 'success');
                logTo(singleTestLog, `üìä Righe: ${result.rowCount}`, 'success');
                logTo(singleTestLog, `üìã Intestazioni: ${JSON.stringify(result.headers)}`, 'success');
                logTo(singleTestLog, `üéØ Anteprima: ${JSON.stringify(result.sample)}`, 'success');
                return true;
            } catch (error) {
                logTo(singleTestLog, `‚ùå GET Ordini - ERRORE: ${error.message}`, 'error');
                return false;
            }
        }

        async function testRegistration() {
            clearLog(singleTestLog);
            try {
                const result = await testRegistration();
                logTo(singleTestLog, `‚úÖ REGISTRAZIONE - SUCCESSO`, 'success');
                logTo(singleTestLog, `üì¶ Dati inviati: ${JSON.stringify(result.request)}`, 'success');
                logTo(singleTestLog, `üì® Risposta: ${JSON.stringify(result.response)}`, 'success');
                return true;
            } catch (error) {
                logTo(singleTestLog, `‚ùå REGISTRAZIONE - ERRORE: ${error.message}`, 'error');
                return false;
            }
        }

        // Esegui test automatico al caricamento
        document.addEventListener('DOMContentLoaded', function() {
            logTo(fullTestLog, 'üîß Sistema di test pronto');
            logTo(fullTestLog, `üåê URL configurato: ${API_URL}`);
            logTo(fullTestLog, 'üí° Clicca "Esegui Test Completo" per verificare tutto');
        });
    </script>
</body>
</html>