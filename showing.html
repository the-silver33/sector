<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API Credenziali - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, button {
            padding: 10px;
            margin: 5px;
            width: 200px;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #005a87;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            color: #856404;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>Test API Credenziali - Debug</h1>

    <div class="test-section">
        <h2>Test Connessione API - Debug Completo</h2>
        <button onclick="testAPIDebug()">Test Connessione Completo</button>
        <div id="apiDebugResult"></div>
    </div>

    <div class="test-section">
        <h2>Test API Principale</h2>
        <button onclick="testMainAPI()">Test API Principale</button>
        <div id="mainAPIResult"></div>
    </div>

    <div class="test-section">
        <h2>Test API Alternativa</h2>
        <button onclick="testAltAPI()">Test API Alternativa</button>
        <div id="altAPIResult"></div>
    </div>

    <div class="test-section">
        <h2>Test RAW Response</h2>
        <button onclick="testRawResponse()">Test Risposta RAW</button>
        <div id="rawResult"></div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzax_zbu_DO5YI-ZrDIQ4TocaCP_ACfpPqzHhEiKDw/dev';
        const API_URL_ALT = 'https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLj7NKo_YXXehHyAbh0Kr3SguoqO_hyHe1tf5ZIju7mbLiTNqy6n1pvVSzRbimOW_CQqLMwjx7Yq7IP97zvRfmSZeWwpI-ODWDSeLdKTobOa9dDSIDJsNSJ3L3HiaPBzCk0iQUrfV7vZArELDAV16ON5XBzy9gmFQ-yHNpO0dyoPlraYOlWTQRBev2TkF_jjnGoIK6G8eUyRyNvrP31F7XuWIcD0FDdOXv17MGgUx40U53t-HOMVFsM1x3h9L3WN-sLjuNabs4jJFX1KkRXfh-EtHG2dJA&lib=MLV1ks7wQQ37SnILDHqD1wVTcg6hxLEu9';

        async function testAPIDebug() {
            const resultDiv = document.getElementById('apiDebugResult');
            resultDiv.innerHTML = '<div class="loading">Test completo in corso...</div>';
            
            let debugInfo = '=== DEBUG API ===\n\n';
            
            // Test API principale
            debugInfo += '1. TEST API PRINCIPALE:\n';
            debugInfo += 'URL: ' + API_URL + '\n';
            
            try {
                const startTime = Date.now();
                const response = await fetch(API_URL);
                const endTime = Date.now();
                
                debugInfo += '✓ Connessione riuscita\n';
                debugInfo += 'Tempo risposta: ' + (endTime - startTime) + 'ms\n';
                debugInfo += 'Status: ' + response.status + ' ' + response.statusText + '\n';
                debugInfo += 'Content-Type: ' + response.headers.get('content-type') + '\n';
                
                const text = await response.text();
                debugInfo += 'Dimensione risposta: ' + text.length + ' caratteri\n\n';
                
                debugInfo += 'RISPOSTA RAW:\n' + text + '\n\n';
                
                // Prova a parsare come JSON
                try {
                    const data = JSON.parse(text);
                    debugInfo += '✓ JSON parsato correttamente\n';
                    debugInfo += 'Struttura dati: ' + JSON.stringify(data, null, 2) + '\n';
                    
                    // Cerca i dati
                    if (data.data) {
                        debugInfo += '✓ Trovato campo "data"\n';
                        debugInfo += 'Contenuto di "data": ' + JSON.stringify(data.data, null, 2) + '\n';
                    } else {
                        debugInfo += '✗ Campo "data" non trovato\n';
                        // Cerca altri campi possibili
                        debugInfo += 'Campi disponibili: ' + Object.keys(data).join(', ') + '\n';
                    }
                    
                } catch (jsonError) {
                    debugInfo += '✗ Errore parsing JSON: ' + jsonError.message + '\n';
                }
                
            } catch (error) {
                debugInfo += '✗ Errore connessione: ' + error.message + '\n\n';
            }
            
            // Test API alternativa
            debugInfo += '2. TEST API ALTERNATIVA:\n';
            debugInfo += 'URL: ' + API_URL_ALT + '\n';
            
            try {
                const startTime = Date.now();
                const response = await fetch(API_URL_ALT);
                const endTime = Date.now();
                
                debugInfo += '✓ Connessione riuscita\n';
                debugInfo += 'Tempo risposta: ' + (endTime - startTime) + 'ms\n';
                debugInfo += 'Status: ' + response.status + ' ' + response.statusText + '\n';
                debugInfo += 'Content-Type: ' + response.headers.get('content-type') + '\n';
                
                const text = await response.text();
                debugInfo += 'Dimensione risposta: ' + text.length + ' caratteri\n\n';
                
                debugInfo += 'RISPOSTA RAW:\n' + text + '\n\n';
                
                // Prova a parsare come JSON
                try {
                    const data = JSON.parse(text);
                    debugInfo += '✓ JSON parsato correttamente\n';
                    debugInfo += 'Struttura dati: ' + JSON.stringify(data, null, 2) + '\n';
                    
                    if (data.data) {
                        debugInfo += '✓ Trovato campo "data"\n';
                        debugInfo += 'Contenuto di "data": ' + JSON.stringify(data.data, null, 2) + '\n';
                    } else {
                        debugInfo += '✗ Campo "data" non trovato\n';
                        debugInfo += 'Campi disponibili: ' + Object.keys(data).join(', ') + '\n';
                    }
                    
                } catch (jsonError) {
                    debugInfo += '✗ Errore parsing JSON: ' + jsonError.message + '\n';
                }
                
            } catch (error) {
                debugInfo += '✗ Errore connessione: ' + error.message + '\n';
            }
            
            resultDiv.innerHTML = '<div class="info">' + debugInfo + '</div>';
        }

        async function testMainAPI() {
            const resultDiv = document.getElementById('mainAPIResult');
            resultDiv.innerHTML = '<div class="loading">Test API principale...</div>';
            
            try {
                const response = await fetch(API_URL);
                const text = await response.text();
                
                let result = 'Status: ' + response.status + '\n';
                result += 'Content-Type: ' + response.headers.get('content-type') + '\n\n';
                result += 'Risposta completa:\n' + text;
                
                resultDiv.innerHTML = '<div class="info">' + result + '</div>';
                
                // Prova a vedere la struttura
                try {
                    const data = JSON.parse(text);
                    console.log('API Principale - Dati parsati:', data);
                } catch (e) {
                    console.log('API Principale - Non è JSON valido');
                }
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">Errore: ' + error.message + '</div>';
            }
        }

        async function testAltAPI() {
            const resultDiv = document.getElementById('altAPIResult');
            resultDiv.innerHTML = '<div class="loading">Test API alternativa...</div>';
            
            try {
                const response = await fetch(API_URL_ALT);
                const text = await response.text();
                
                let result = 'Status: ' + response.status + '\n';
                result += 'Content-Type: ' + response.headers.get('content-type') + '\n\n';
                result += 'Risposta completa:\n' + text;
                
                resultDiv.innerHTML = '<div class="info">' + result + '</div>';
                
                // Prova a vedere la struttura
                try {
                    const data = JSON.parse(text);
                    console.log('API Alternativa - Dati parsati:', data);
                } catch (e) {
                    console.log('API Alternativa - Non è JSON valido');
                }
                
            } catch (error) {
                resultDiv.innerHTML = '<div class="error">Errore: ' + error.message + '</div>';
            }
        }

        async function testRawResponse() {
            const resultDiv = document.getElementById('rawResult');
            resultDiv.innerHTML = '<div class="loading">Test risposta RAW...</div>';
            
            // Test con diversi metodi
            const methods = [
                { name: 'GET semplice', url: API_URL },
                { name: 'GET con cache bust', url: API_URL + '?t=' + Date.now() },
                { name: 'API Alternativa', url: API_URL_ALT }
            ];
            
            let results = '';
            
            for (const method of methods) {
                results += '=== ' + method.name + ' ===\n';
                results += 'URL: ' + method.url + '\n';
                
                try {
                    const response = await fetch(method.url);
                    const text = await response.text();
                    
                    results += 'Status: ' + response.status + '\n';
                    results += 'Tipo: ' + response.headers.get('content-type') + '\n';
                    results += 'Primi 500 caratteri:\n' + text.substring(0, 500) + '\n\n';
                    
                } catch (error) {
                    results += 'Errore: ' + error.message + '\n\n';
                }
            }
            
            resultDiv.innerHTML = '<div class="info">' + results + '</div>';
        }

        // Test automatico
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Debug tool caricato');
            // testAPIDebug(); // Scommenta per test automatico
        });
    </script>
</body>
</html>