<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gestione Unità Militari</title>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #e67e22;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .map-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }
        
        .map-btn:hover {
            background-color: #2980b9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            background-color: var(--light-color);
            transition: background-color 0.3s;
        }
        
        .tab.active {
            background-color: white;
            font-weight: bold;
            border-bottom: 3px solid var(--accent-color);
        }
        
        .tab:hover:not(.active) {
            background-color: #dfe6e9;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 2rem;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: var(--secondary-color);
        }
        
        button.secondary:hover {
            background-color: #2c3e50;
        }
        
        .units-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .unit-card {
            background-color: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid var(--accent-color);
        }
        
        .unit-card.pending {
            border-left-color: var(--warning-color);
        }
        
        .unit-card.approved {
            border-left-color: var(--success-color);
        }
        
        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .unit-id {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .unit-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .unit-details {
            margin-top: 1rem;
        }
        
        .order-chain {
            margin-top: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 1rem;
        }
        
        .order-item {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent-color);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .order-type {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .remove-order {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
        }
        
        .message {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .stats-btn {
            background-color: var(--secondary-color);
            margin-top: 1rem;
        }
        
        @media (max-width: 768px) {
            .units-list {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Sistema Militare</div>
        <a href="https://the-silver33.github.io/sector/map.html" class="map-btn">
            <span>Mappa</span>
        </a>
    </header>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="register">Registrazione Unità</div>
            <div class="tab" data-tab="units">Unità Registrate</div>
            <div class="tab" data-tab="orders">Invia Ordini</div>
        </div>
        
        <!-- Sezione Registrazione Unità -->
        <div id="register" class="tab-content active">
            <h2>Registrazione Nuova Unità</h2>
            <form id="registration-form">
                <div class="form-group">
                    <label for="matricola">Matricola *</label>
                    <input type="text" id="matricola" name="matricola" pattern="[A-Z]{3}-[0-9]+" title="Formato: ABC-123 (3 lettere maiuscole, trattino, numeri)" required>
                    <small>Formato: ABC-123 (3 lettere maiuscole, trattino, numeri)</small>
                </div>
                
                <div class="form-group">
                    <label for="nick">Nickname (Discord) *</label>
                    <input type="text" id="nick" name="nick" required>
                </div>
                
                <div class="form-group">
                    <label for="tipo">Tipo Unità *</label>
                    <select id="tipo" name="tipo" required>
                        <option value="">Seleziona tipo</option>
                        <option value="Fanteria">Fanteria</option>
                        <option value="Motorizzata">Motorizzata</option>
                        <option value="Corazzata">Corazzata</option>
                        <option value="Artiglieria">Artiglieria</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="movimento">Movimento *</label>
                    <input type="number" id="movimento" name="movimento" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="visione">Visione *</label>
                    <input type="number" id="visione" name="visione" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="armatura">Armatura *</label>
                    <input type="number" id="armatura" name="armatura" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="rifornimenti">Capacità Rifornimenti *</label>
                    <input type="number" id="rifornimenti" name="rifornimenti" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="componenti">Componenti</label>
                    <textarea id="componenti" name="componenti" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="password">Password *</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <div class="form-group">
                    <label for="confirm-password">Conferma Password *</label>
                    <input type="password" id="confirm-password" name="confirm-password" required>
                </div>
                
                <button type="submit">Registra Unità</button>
            </form>
        </div>
        
        <!-- Sezione Unità Registrate -->
        <div id="units" class="tab-content">
            <h2>Unità Registrate</h2>
            <button class="refresh-btn" id="refresh-units">
                <span>Aggiorna Lista</span>
            </button>
            <div id="units-list" class="units-list">
                <!-- Le unità verranno caricate qui dinamicamente -->
            </div>
        </div>
        
        <!-- Sezione Invia Ordini -->
        <div id="orders" class="tab-content">
            <h2>Invia Ordini</h2>
            
            <div class="form-group">
                <label for="order-unit">Seleziona Unità *</label>
                <select id="order-unit" name="order-unit" required>
                    <option value="">Seleziona unità</option>
                </select>
            </div>
            
            <div class="form-group" id="password-section" style="display: none;">
                <label for="unit-password">Password Unità *</label>
                <input type="password" id="unit-password" name="unit-password">
            </div>
            
            <div id="order-form" style="display: none;">
                <div class="form-group">
                    <label for="order-type">Tipo Ordine *</label>
                    <select id="order-type" name="order-type" required>
                        <option value="">Seleziona tipo ordine</option>
                        <option value="attivare">Attivare Componenti</option>
                        <option value="salire">Salire su Mezzo</option>
                        <option value="scendere">Scendere da Mezzo</option>
                        <option value="consumare">Consumare Rifornimenti</option>
                        <option value="cura">Cura</option>
                        <option value="ricaricare">Ricaricare Componente</option>
                        <option value="cedere">Cedere Rifornimenti</option>
                        <option value="muoversi">Muoversi</option>
                    </select>
                </div>
                
                <div id="order-details">
                    <!-- I dettagli specifici per ogni tipo di ordine verranno mostrati qui -->
                </div>
                
                <button type="button" id="add-order">Aggiungi Ordine</button>
                
                <div class="order-chain" id="order-chain">
                    <h3>Catena Ordini</h3>
                    <div id="order-items">
                        <!-- Gli ordini aggiunti verranno mostrati qui -->
                    </div>
                </div>
                
                <button type="button" id="submit-orders" style="display: none;">Invia Ordini</button>
            </div>
        </div>
    </div>

    <script>
        // URL dell'API Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbzUAJ1rJrUp_QRD0Q_ckbWAbmNyuoi0Ln5c8FqN6Kjt21oJfRRox-wUQGMjd5O6NQ3U/exec';
        
        // Elementi DOM
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const registrationForm = document.getElementById('registration-form');
        const unitsList = document.getElementById('units-list');
        const refreshUnitsBtn = document.getElementById('refresh-units');
        const orderUnitSelect = document.getElementById('order-unit');
        const passwordSection = document.getElementById('password-section');
        const orderForm = document.getElementById('order-form');
        const orderTypeSelect = document.getElementById('order-type');
        const orderDetails = document.getElementById('order-details');
        const addOrderBtn = document.getElementById('add-order');
        const orderItems = document.getElementById('order-items');
        const submitOrdersBtn = document.getElementById('submit-orders');
        const unitPasswordInput = document.getElementById('unit-password');
        
        // Gestione delle tab
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Aggiorna tab attiva
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Mostra contenuto tab
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === tabId) {
                        content.classList.add('active');
                    }
                });
                
                // Se è la tab delle unità, carica le unità
                if (tabId === 'units') {
                    loadUnits();
                }
                
                // Se è la tab degli ordini, carica le unità approvate
                if (tabId === 'orders') {
                    loadApprovedUnits();
                }
            });
        });
        
        // Registrazione unità
        registrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Verifica che le password coincidano
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (password !== confirmPassword) {
                showMessage('Le password non coincidono', 'error');
                return;
            }
            
            // Prepara i dati
            const formData = new FormData(registrationForm);
            const data = {
                action: 'register',
                data: {
                    matricola: formData.get('matricola'),
                    password: await hashPassword(password),
                    nick: formData.get('nick'),
                    tipo: formData.get('tipo'),
                    movimento: parseInt(formData.get('movimento')),
                    visione: parseInt(formData.get('visione')),
                    armatura: parseInt(formData.get('armatura')),
                    rifornimenti: parseInt(formData.get('rifornimenti')),
                    componenti: formData.get('componenti')
                }
            };
            
            // Invia richiesta
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Unità registrata con successo! In attesa di approvazione.', 'success');
                    registrationForm.reset();
                } else {
                    showMessage('Errore durante la registrazione: ' + result.message, 'error');
                }
            } catch (error) {
                showMessage('Errore di connessione: ' + error.message, 'error');
            }
        });
        
        // Carica le unità registrate
        async function loadUnits() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (data.success) {
                    displayUnits(data.data);
                } else {
                    showMessage('Errore nel caricamento delle unità', 'error');
                }
            } catch (error) {
                showMessage('Errore di connessione: ' + error.message, 'error');
            }
        }
        
        // Mostra le unità nella lista
        function displayUnits(units) {
            unitsList.innerHTML = '';
            
            if (units.length === 0) {
                unitsList.innerHTML = '<p>Nessuna unità registrata.</p>';
                return;
            }
            
            units.forEach(unit => {
                const unitCard = document.createElement('div');
                unitCard.className = `unit-card ${unit.approvata === 'si' ? 'approved' : 'pending'}`;
                
                const statusText = unit.approvata === 'si' ? 'Schierata' : 'In attesa di schieramento';
                const statusClass = unit.approvata === 'si' ? 'status-approved' : 'status-pending';
                
                unitCard.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-id">${unit.matricola}</div>
                        <div class="unit-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="unit-nick">${unit.nick}</div>
                    <div class="unit-type">${unit.tipo}</div>
                    <div class="unit-details">
                        <div>Posizione: ${unit.posizione}</div>
                        <div>Movimento: ${unit.movimento}</div>
                        <div>Visione: ${unit.visione}</div>
                        <div>Armatura: ${unit.armatura}</div>
                        <div>Rifornimenti: ${unit.rifornimenti}</div>
                    </div>
                    <button class="stats-btn" data-matricola="${unit.matricola}">Visualizza Statistiche</button>
                `;
                
                unitsList.appendChild(unitCard);
            });
            
            // Aggiungi event listener per i pulsanti delle statistiche
            document.querySelectorAll('.stats-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const matricola = btn.getAttribute('data-matricola');
                    showUnitStats(matricola, units);
                });
            });
        }
        
        // Mostra statistiche dettagliate di un'unità
        function showUnitStats(matricola, units) {
            const unit = units.find(u => u.matricola === matricola);
            
            if (!unit) return;
            
            // Crea un modal o popup con le statistiche
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h2>Statistiche Unità ${unit.matricola}</h2>
                    <div style="margin-top: 1rem;">
                        <p><strong>Nickname:</strong> ${unit.nick}</p>
                        <p><strong>Tipo:</strong> ${unit.tipo}</p>
                        <p><strong>Posizione:</strong> ${unit.posizione}</p>
                        <p><strong>Movimento:</strong> ${unit.movimento}</p>
                        <p><strong>Visione:</strong> ${unit.visione}</p>
                        <p><strong>Armatura:</strong> ${unit.armatura}</p>
                        <p><strong>Rifornimenti:</strong> ${unit.rifornimenti}</p>
                        <p><strong>Trasportata:</strong> ${unit.trasportata || 'N/A'}</p>
                        <p><strong>Componenti:</strong> ${unit.componenti || 'Nessuno'}</p>
                    </div>
                    <button id="close-modal" style="margin-top: 1rem;">Chiudi</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Chiudi il modal
            document.getElementById('close-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }
        
        // Carica le unità approvate per gli ordini
        async function loadApprovedUnits() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (data.success) {
                    const approvedUnits = data.data.filter(unit => unit.approvata === 'si');
                    populateOrderUnitSelect(approvedUnits);
                } else {
                    showMessage('Errore nel caricamento delle unità', 'error');
                }
            } catch (error) {
                showMessage('Errore di connessione: ' + error.message, 'error');
            }
        }
        
        // Popola il selettore delle unità per gli ordini
        function populateOrderUnitSelect(units) {
            orderUnitSelect.innerHTML = '<option value="">Seleziona unità</option>';
            
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.matricola;
                option.textContent = `${unit.matricola} - ${unit.nick} (${unit.tipo})`;
                orderUnitSelect.appendChild(option);
            });
        }
        
        // Quando si seleziona un'unità per gli ordini
        orderUnitSelect.addEventListener('change', () => {
            if (orderUnitSelect.value) {
                passwordSection.style.display = 'block';
            } else {
                passwordSection.style.display = 'none';
                orderForm.style.display = 'none';
            }
        });
        
        // Verifica password per l'unità selezionata
        unitPasswordInput.addEventListener('input', async () => {
            if (unitPasswordInput.value.length > 0) {
                // In un'implementazione reale, qui verificheremmo la password con l'API
                // Per ora, mostriamo il form degli ordini dopo un ritardo simulato
                setTimeout(() => {
                    orderForm.style.display = 'block';
                }, 500);
            } else {
                orderForm.style.display = 'none';
            }
        });
        
        // Gestione del tipo di ordine selezionato
        orderTypeSelect.addEventListener('change', () => {
            updateOrderDetails();
        });
        
        // Aggiorna i dettagli dell'ordine in base al tipo selezionato
        function updateOrderDetails() {
            const orderType = orderTypeSelect.value;
            let html = '';
            
            switch (orderType) {
                case 'attivare':
                    html = `
                        <div class="form-group">
                            <label for="componente">Componente da Attivare</label>
                            <input type="text" id="componente" name="componente">
                        </div>
                    `;
                    break;
                    
                case 'salire':
                    html = `
                        <div class="form-group">
                            <label for="posizione-destinazione">Posizione Destinazione</label>
                            <input type="text" id="posizione-destinazione" name="posizione-destinazione">
                        </div>
                    `;
                    break;
                    
                case 'scendere':
                    html = `
                        <div class="form-group">
                            <label for="posizione">Posizione</label>
                            <input type="text" id="posizione" name="posizione">
                        </div>
                        <div class="form-group">
                            <label for="matricola-mezzo">Matricola Mezzo</label>
                            <input type="text" id="matricola-mezzo" name="matricola-mezzo">
                        </div>
                    `;
                    break;
                    
                case 'consumare':
                    html = `
                        <div class="form-group">
                            <label for="quantita-rifornimenti">Quantità Rifornimenti</label>
                            <input type="number" id="quantita-rifornimenti" name="quantita-rifornimenti" min="1">
                        </div>
                    `;
                    break;
                    
                case 'ricaricare':
                    html = `
                        <div class="form-group">
                            <label for="componente-ricaricare">Componente da Ricaricare</label>
                            <input type="text" id="componente-ricaricare" name="componente-ricaricare">
                        </div>
                    `;
                    break;
                    
                case 'cedere':
                    html = `
                        <div class="form-group">
                            <label for="unita-destinataria">Unità Destinataria</label>
                            <select id="unita-destinataria" name="unita-destinataria">
                                <option value="">Seleziona unità</option>
                                <!-- Le opzioni verranno popolate dinamicamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantita-cedere">Quantità</label>
                            <input type="number" id="quantita-cedere" name="quantita-cedere" min="1">
                        </div>
                    `;
                    // Popola le unità destinatarie
                    setTimeout(() => {
                        populateDestinataryUnits();
                    }, 100);
                    break;
                    
                case 'muoversi':
                    html = `
                        <div class="form-group">
                            <label for="casella-destinazione">Casella Destinazione</label>
                            <input type="text" id="casella-destinazione" name="casella-destinazione">
                        </div>
                    `;
                    break;
                    
                default:
                    html = '';
            }
            
            orderDetails.innerHTML = html;
        }
        
        // Popola le unità destinatarie per l'ordine "Cedere Rifornimenti"
        async function populateDestinataryUnits() {
            const unitaDestinatariaSelect = document.getElementById('unita-destinataria');
            
            if (!unitaDestinatariaSelect) return;
            
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (data.success) {
                    const approvedUnits = data.data.filter(unit => 
                        unit.approvata === 'si' && unit.matricola !== orderUnitSelect.value
                    );
                    
                    unitaDestinatariaSelect.innerHTML = '<option value="">Seleziona unità</option>';
                    
                    approvedUnits.forEach(unit => {
                        const option = document.createElement('option');
                        option.value = unit.matricola;
                        option.textContent = `${unit.matricola} - ${unit.nick} (${unit.tipo})`;
                        unitaDestinatariaSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Errore nel caricamento delle unità destinatarie:', error);
            }
        }
        
        // Aggiungi ordine alla catena
        addOrderBtn.addEventListener('click', () => {
            const orderType = orderTypeSelect.value;
            const matricola = orderUnitSelect.value;
            
            if (!orderType || !matricola) {
                showMessage('Seleziona un tipo di ordine e verifica di aver selezionato un\'unità', 'error');
                return;
            }
            
            let orderData = {
                tipoOrdine: orderType,
                dettagli: '',
                target: '',
                quantità: ''
            };
            
            // Raccogli i dettagli specifici in base al tipo di ordine
            switch (orderType) {
                case 'attivare':
                    orderData.dettagli = document.getElementById('componente').value || '';
                    break;
                    
                case 'salire':
                    orderData.dettagli = document.getElementById('posizione-destinazione').value || '';
                    break;
                    
                case 'scendere':
                    orderData.dettagli = document.getElementById('posizione').value || '';
                    orderData.target = document.getElementById('matricola-mezzo').value || '';
                    break;
                    
                case 'consumare':
                    orderData.quantità = document.getElementById('quantita-rifornimenti').value || '';
                    break;
                    
                case 'ricaricare':
                    orderData.dettagli = document.getElementById('componente-ricaricare').value || '';
                    break;
                    
                case 'cedere':
                    orderData.target = document.getElementById('unita-destinataria').value || '';
                    orderData.quantità = document.getElementById('quantita-cedere').value || '';
                    break;
                    
                case 'muoversi':
                    orderData.dettagli = document.getElementById('casella-destinazione').value || '';
                    break;
            }
            
            // Aggiungi l'ordine alla catena
            addOrderToChain(orderData);
            
            // Pulisci il form
            orderTypeSelect.value = '';
            orderDetails.innerHTML = '';
            
            // Mostra il pulsante per inviare gli ordini
            submitOrdersBtn.style.display = 'block';
        });
        
        // Aggiungi ordine alla catena visuale
        function addOrderToChain(orderData) {
            const orderItem = document.createElement('div');
            orderItem.className = 'order-item';
            
            let detailsText = '';
            if (orderData.dettagli) detailsText += `Dettagli: ${orderData.dettagli}`;
            if (orderData.target) detailsText += ` | Target: ${orderData.target}`;
            if (orderData.quantità) detailsText += ` | Quantità: ${orderData.quantità}`;
            
            orderItem.innerHTML = `
                <div class="order-header">
                    <div class="order-type">${getOrderTypeText(orderData.tipoOrdine)}</div>
                    <button class="remove-order">Rimuovi</button>
                </div>
                <div class="order-details">${detailsText}</div>
            `;
            
            // Aggiungi l'evento per rimuovere l'ordine
            orderItem.querySelector('.remove-order').addEventListener('click', () => {
                orderItems.removeChild(orderItem);
                
                // Nascondi il pulsante di invio se non ci sono più ordini
                if (orderItems.children.length === 0) {
                    submitOrdersBtn.style.display = 'none';
                }
            });
            
            orderItems.appendChild(orderItem);
        }
        
        // Testo descrittivo per i tipi di ordine
        function getOrderTypeText(type) {
            const types = {
                'attivare': 'Attivare Componenti',
                'salire': 'Salire su Mezzo',
                'scendere': 'Scendere da Mezzo',
                'consumare': 'Consumare Rifornimenti',
                'cura': 'Cura',
                'ricaricare': 'Ricaricare Componente',
                'cedere': 'Cedere Rifornimenti',
                'muoversi': 'Muoversi'
            };
            
            return types[type] || type;
        }
        
        // Invia gli ordini
        submitOrdersBtn.addEventListener('click', async () => {
            const matricola = orderUnitSelect.value;
            const orders = [];
            
            // Raccogli tutti gli ordini dalla catena
            for (let i = 0; i < orderItems.children.length; i++) {
                const orderItem = orderItems.children[i];
                const orderType = orderItem.querySelector('.order-type').textContent;
                const detailsText = orderItem.querySelector('.order-details').textContent;
                
                // Estrai i dettagli dal testo
                let dettagli = '';
                let target = '';
                let quantità = '';
                
                const parts = detailsText.split(' | ');
                parts.forEach(part => {
                    if (part.startsWith('Dettagli: ')) {
                        dettagli = part.replace('Dettagli: ', '');
                    } else if (part.startsWith('Target: ')) {
                        target = part.replace('Target: ', '');
                    } else if (part.startsWith('Quantità: ')) {
                        quantità = part.replace('Quantità: ', '');
                    }
                });
                
                // Trova la chiave del tipo di ordine
                const tipoOrdine = Object.keys(getOrderTypeText).find(key => 
                    getOrderTypeText(key) === orderType
                ) || orderType.toLowerCase();
                
                orders.push({
                    matricola,
                    tipoOrdine,
                    dettagli,
                    target,
                    quantità,
                    timestamp: new Date().toISOString()
                });
            }
            
            // Invia ogni ordine individualmente
            try {
                for (const order of orders) {
                    const data = {
                        action: 'submitOrder',
                        data: order
                    };
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (!result.success) {
                        showMessage(`Errore nell'invio dell'ordine: ${result.message}`, 'error');
                        return;
                    }
                }
                
                showMessage('Ordini inviati con successo!', 'success');
                
                // Pulisci la catena degli ordini
                orderItems.innerHTML = '';
                submitOrdersBtn.style.display = 'none';
                
            } catch (error) {
                showMessage('Errore di connessione: ' + error.message, 'error');
            }
        });
        
        // Aggiorna la lista delle unità
        refreshUnitsBtn.addEventListener('click', loadUnits);
        
        // Funzione per hash della password (SHA-256)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // Mostra messaggi di stato
        function showMessage(message, type) {
            // Rimuovi messaggi precedenti
            const existingMessages = document.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            // Crea nuovo messaggio
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            // Aggiungi il messaggio in cima al container
            const container = document.querySelector('.container');
            container.insertBefore(messageDiv, container.firstChild);
            
            // Rimuovi il messaggio dopo 5 secondi
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            // Carica le unità approvate per la sezione ordini
            loadApprovedUnits();
        });
    </script>
</body>
</html>