<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Definitivo Sistema Unit√†</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; border: none; border-radius: 3px; }
        .btn-primary { background: #007cba; color: white; }
        .btn-success { background: #28a745; color: white; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 3px; margin-top: 10px; font-family: monospace; font-size: 12px; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <h1>üß™ Test Definitivo Sistema Unit√†</h1>

    <div class="test-section">
        <h3>1. Test Directo (apre in nuova finestra)</h3>
        <button onclick="testDirect()" class="btn-primary">Test URL Diretto</button>
        <p><small>Questo aprir√† l'URL direttamente per vedere se funziona</small></p>
    </div>

    <div class="test-section">
        <h3>2. Test con Google Forms Workaround</h3>
        <button onclick="testWithForm()" class="btn-primary">Test con Form Alternativo</button>
    </div>

    <div class="test-section">
        <h3>3. Test Registrazione</h3>
        <button onclick="testRegistration()" class="btn-success">Test Registrazione Unit√†</button>
        <div id="registrationResult" class="log"></div>
    </div>

    <div class="test-section">
        <h3>üìä Risultati Test</h3>
        <div id="testResults" class="log">
            Clicca i pulsanti per eseguire i test...
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyLgS8rTrhKs3tufWo2Tm4zAyEMhWsW0mr-QPciSzNh33zuGgdCRjwPzuslhE5OMyDt/exec';

        function logResult(message, type = 'info') {
            const results = document.getElementById('testResults');
            const time = new Date().toLocaleTimeString();
            results.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
        }

        // 1. Test diretto - apre l'URL in nuova finestra
        function testDirect() {
            const testUrls = [
                API_URL + '?sheet=Unit√†',
                API_URL + '?sheet=Unit√Ä', 
                API_URL + '?sheet=Ordini'
            ];
            
            testUrls.forEach(url => {
                window.open(url, '_blank');
                logResult(`üîó Aperto: ${url}`, 'info');
            });
        }

        // 2. Test con approccio alternativo
        async function testWithForm() {
            logResult('üîÑ Tentativo con fetch semplice...', 'info');
            
            try {
                // Prova con diversi endpoint
                const endpoints = [
                    '?sheet=Unit√†',
                    '?sheet=Unit√Ä',
                    '?sheet=Ordini',
                    ''
                ];
                
                for (const endpoint of endpoints) {
                    const url = API_URL + endpoint;
                    logResult(`üîç Test: ${url}`, 'info');
                    
                    try {
                        const response = await fetch(url, { 
                            method: 'GET',
                            mode: 'no-cors' // Accetta anche risposte non CORS
                        });
                        logResult(`‚úÖ Richiesta inviata a: ${endpoint}`, 'success');
                    } catch (error) {
                        logResult(`‚ùå Errore: ${error.message}`, 'error');
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            } catch (error) {
                logResult(`üí• Errore generale: ${error.message}`, 'error');
            }
        }

        // 3. Test registrazione
        async function testRegistration() {
            const resultDiv = document.getElementById('registrationResult');
            resultDiv.innerHTML = 'üîÑ Invio dati di registrazione...';
            
            const testData = {
                matricola: 'TES-' + Math.floor(Math.random() * 1000),
                nick: 'test_user_' + Date.now(),
                tipo: 'Fanteria',
                movimento: 2,
                visione: 1,
                armatura: 1,
                rifornimenti: 3,
                componenti: 'Fucile di Test',
                password: 'test123'
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'register',
                        data: testData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                resultDiv.innerHTML = `
                    <div class="success">
                        <strong>‚úÖ REGISTRAZIONE RIUSCITA!</strong><br>
                        Messaggio: ${result.message}<br>
                        Dati: ${JSON.stringify(testData)}
                    </div>
                `;
                logResult('‚úÖ Registrazione completata con successo!', 'success');
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <strong>‚ùå ERRORE REGISTRAZIONE</strong><br>
                        Errore: ${error.message}
                    </div>
                `;
                logResult(`‚ùå Errore registrazione: ${error.message}`, 'error');
            }
        }

        // Test iniziale
        document.addEventListener('DOMContentLoaded', function() {
            logResult('üöÄ Sistema di test pronto');
            logResult(`üì° URL API: ${API_URL}`);
            logResult('üí° Suggerimento: Prova prima "Test URL Diretto" per verificare manualmente');
        });
    </script>
</body>
</html>