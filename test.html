<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Militare - Dashboard</title>

    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-crosshairs"></i>
                    <h1>Sistema Militare - Dashboard</h1>
                </div>
                <button onclick="loadAllData()" class="btn-success">
                    <i class="fas fa-sync-alt"></i> Aggiorna Dati
                </button>
            </div>
        </header>

        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" data-tab="register">
                    <i class="fas fa-user-plus"></i> Registrazione Unit√†
                </div>
                <div class="tab" data-tab="units">
                    <i class="fas fa-users"></i> Unit√† Registrate
                </div>
                <div class="tab" data-tab="orders">
                    <i class="fas fa-paper-plane"></i> Invia Ordini
                </div>
            </div>

            <!-- Registrazione Unit√† -->
            <div id="register" class="tab-content active">
                <div class="section-title">
                    <i class="fas fa-user-plus"></i>
                    <h2>Registra Nuova Unit√†</h2>
                </div>
                
                <div class="form-container">
                    <form id="registrationForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="matricola" class="required">
                                    <i class="fas fa-id-card"></i> Matricola
                                </label>
                                <input type="text" id="matricola" pattern="[A-Z]{3}-[0-9]+" required placeholder="ABC-123">
                                <small>Formato: ABC-123 (3 lettere maiuscole, trattino, numeri)</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="nick" class="required">
                                    <i class="fas fa-user-tag"></i> Nickname (Discord)
                                </label>
                                <input type="text" id="nick" required placeholder="Inserisci il nickname">
                            </div>
                            
                            <div class="form-group">
                                <label for="tipo" class="required">
                                    <i class="fas fa-tags"></i> Tipo Unit√†
                                </label>
                                <select id="tipo" required>
                                    <option value="">Seleziona tipo</option>
                                    <option value="Fanteria">Fanteria</option>
                                    <option value="Motorizzata">Motorizzata</option>
                                    <option value="Corazzata">Corazzata</option>
                                    <option value="Artiglieria">Artiglieria</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="movimento" class="required">
                                    <i class="fas fa-walking"></i> Movimento
                                </label>
                                <input type="number" id="movimento" min="1" required placeholder="1">
                            </div>
                            
                            <div class="form-group">
                                <label for="visione" class="required">
                                    <i class="fas fa-eye"></i> Visione
                                </label>
                                <input type="number" id="visione" min="1" required placeholder="1">
                            </div>
                            
                            <div class="form-group">
                                <label for="armatura" class="required">
                                    <i class="fas fa-shield-alt"></i> Armatura
                                </label>
                                <input type="number" id="armatura" min="1" required placeholder="1">
                            </div>
                            
                            <div class="form-group">
                                <label for="rifornimenti" class="required">
                                    <i class="fas fa-boxes"></i> Capacit√† Rifornimenti
                                </label>
                                <input type="number" id="rifornimenti" min="1" required placeholder="1">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="componenti">
                                <i class="fas fa-cogs"></i> Componenti
                            </label>
                            <textarea id="componenti" rows="3" placeholder="Descrizione componenti..."></textarea>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="password" class="required">
                                    <i class="fas fa-lock"></i> Password
                                </label>
                                <input type="password" id="password" required placeholder="Inserisci password">
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword" class="required">
                                    <i class="fas fa-lock"></i> Conferma Password
                                </label>
                                <input type="password" id="confirmPassword" required placeholder="Conferma password">
                            </div>
                        </div>
                        
                        <button type="submit">
                            <i class="fas fa-user-plus"></i> Registra Unit√†
                        </button>
                    </form>
                </div>
            </div>

            <!-- Unit√† Registrate -->
            <div id="units" class="tab-content">
                <div class="section-title">
                    <i class="fas fa-users"></i>
                    <h2>Unit√† Registrate</h2>
                </div>
                
                <div class="units-stats">
                    <div class="unit-stat">
                        <div class="unit-stat-value" id="approvedCount">0</div>
                        <div class="unit-stat-label">Approvate</div>
                    </div>
                    <div class="unit-stat">
                        <div class="unit-stat-value" id="pendingCount">0</div>
                        <div class="unit-stat-label">In Attesa</div>
                    </div>
                </div>
                
                <div id="unitsGrid" class="units-grid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Caricamento unit√† in corso...</p>
                    </div>
                </div>
            </div>

            <!-- Invia Ordini -->
            <div id="orders" class="tab-content">
                <div class="section-title">
                    <i class="fas fa-paper-plane"></i>
                    <h2>Invia Ordini</h2>
                </div>
                
                <div class="card">
                    <div class="form-group">
                        <label for="orderUnit" class="required">
                            <i class="fas fa-user"></i> Seleziona Unit√°
                        </label>
                        <select id="orderUnit" required>
                            <option value="">Caricamento unit√† approvate...</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="passwordSection" style="display: none;">
                        <label for="unitPassword" class="required">
                            <i class="fas fa-lock"></i> Password Unit√°
                        </label>
                        <input type="password" id="unitPassword" placeholder="Inserisci password unit√†">
                    </div>
                    
                    <div id="orderForm" style="display: none;">
                        <div class="form-group">
                            <label for="orderType" class="required">
                                <i class="fas fa-tasks"></i> Tipo Ordine
                            </label>
                            <select id="orderType" required>
                                <option value="">Seleziona tipo ordine</option>
                                <option value="muoversi">Muoversi</option>
                                <option value="salire">Salire su Mezzo</option>
                                <option value="scendere">Scendere da Mezzo</option>
                                <option value="attivare">Attivare Componenti</option>
                                <option value="cura">Cura</option>
                                <option value="ricaricare">Ricaricare Componente</option>
                                <option value="consumare">Consumare Rifornimenti</option>
                                <option value="cedere">Cedere Rifornimenti</option>
                            </select>
                        </div>
                        
                        <div id="orderDetails">
                            <!-- Dettagli dinamici -->
                        </div>
                        
                        <button onclick="addOrderToChain()" class="btn-success">
                            <i class="fas fa-plus"></i> Aggiungi alla Catena
                        </button>
                        
                        <div class="orders-list" id="orderChain" style="display: none;">
                            <h3 class="card-title">
                                <i class="fas fa-link"></i> Catena Ordini
                            </h3>
                            <div id="orderItems"></div>
                            <button onclick="submitAllOrders()" class="btn-success">
                                <i class="fas fa-rocket"></i> Invia Tutti gli Ordini
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationText">Operazione completata con successo!</span>
    </div>

    <script>
        
        // Gestione delle tab
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Rimuovi classe active da tutte le tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Aggiungi classe active alla tab cliccata
                tab.classList.add('active');
                
                // Mostra il contenuto corrispondente
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Se √® la tab delle unit√†, carica i dati
                if (tabId === 'units') {
                    loadUnits();
                }
            });
        });
        
        // Caricamento dati
        async function loadAllData() {
            showNotification('üîÑ Caricamento dati in corso...', 'warning');
            try {
                console.log('Tentativo fetch diretto...');
                const response = await fetch(API_URL, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    processLoadedData(data);
                    return;
                }
            } catch (fetchError) {
                console.log('Fetch diretto fallito:', fetchError);
            }
        }
        
        // Visualizza unit√† nella griglia
        function displayUnits(units) {
            const unitsGrid = document.getElementById('unitsGrid');
            
            if (units.length === 0) {
                unitsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>Nessuna unit√† trovata</h3>
                        <p>Non ci sono unit√† registrate nel sistema.</p>
                    </div>
                `;
                return;
            }
            
            // Calcola statistiche
            const approvedCount = units.filter(unit => unit.status === 'approved').length;
            const pendingCount = units.filter(unit => unit.status === 'pending').length;
            
            document.getElementById('approvedCount').textContent = approvedCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            
            unitsGrid.innerHTML = units.map(unit => `
                <div class="unit-card ${unit.status === 'approved' ? 'approved' : 'pending'}">
                    <div class="unit-header">
                        <div class="unit-id">${unit.id}</div>
                        <span class="status ${unit.status === 'approved' ? 'status-approved' : 'status-pending'}">
                            <i class="fas ${unit.status === 'approved' ? 'fa-check' : 'fa-clock'}"></i>
                            ${unit.status === 'approved' ? 'Approvata' : 'In Attesa'}
                        </span>
                    </div>
                    <div class="unit-nick">${unit.nick}</div>
                    <div class="unit-details">
                        <div class="unit-detail">
                            <span class="detail-label">Tipo</span>
                            <span class="detail-value">${unit.tipo}</span>
                        </div>
                        <div class="unit-detail">
                            <span class="detail-label">Movimento</span>
                            <span class="detail-value">${unit.movimento}</span>
                        </div>
                        <div class="unit-detail">
                            <span class="detail-label">Visione</span>
                            <span class="detail-value">${unit.visione}</span>
                        </div>
                        <div class="unit-detail">
                            <span class="detail-label">Armatura</span>
                            <span class="detail-value">${unit.armatura}</span>
                        </div>
                        <div class="unit-detail">
                            <span class="detail-label">Rifornimenti</span>
                            <span class="detail-value">${unit.rifornimenti}</span>
                        </div>
                    </div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn-success" style="padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-edit"></i> Modifica
                        </button>
                        <button class="btn-danger" style="padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-trash"></i> Elimina
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // URL DELLE API
        const API_URL = 'https://script.google.com/macros/s/AKfycbzOnva7d51fQGtk6tEB0Wk-1GqyqLSXbuapSf32Hqu29uaIIhExwq07F9sHITYxagI/exec';
        const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdl4rtf7gXKCmJJgcePMJ-EE21XChmf14OX4vqkdqJ9zUXy6A/formResponse';
        const FORM_FIELD_ID = 'entry.1167099953';

        let allUnits = [];
        let approvedUnits = [];
        let currentOrders = [];


        // INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            setupEventListeners();
            showNotification('Sistema caricato! ID campo trovato: ' + FORM_FIELD_ID, 'success');
        });

        function setupEventListeners() {
            // Gestione tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                    
                    if (tab.dataset.tab === 'units') {
                        loadUnits();
                    } else if (tab.dataset.tab === 'orders') {
                        loadApprovedUnits();
                    }
                });
            });

            // Selezione unit√† per ordini
            document.getElementById('orderUnit').addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('passwordSection').style.display = 'block';
                } else {
                    document.getElementById('passwordSection').style.display = 'none';
                    document.getElementById('orderForm').style.display = 'none';
                }
            });

            // Verifica password
            document.getElementById('unitPassword').addEventListener('input', function() {
                if (this.value.length > 0) {
                    verifyPassword();
                }
            });

            // Cambio tipo ordine
            document.getElementById('orderType').addEventListener('change', updateOrderDetails);

            // Registrazione form
            document.getElementById('registrationForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleRegistration();
            });
        }

        function processLoadedData(data) {
            if (data && data.success && Array.isArray(data.data)) {
                allUnits = data.data;
                approvedUnits = allUnits.filter(unit => unit.approvata === 'SI');
                updateStats();
                loadUnits();
                loadApprovedUnits();
                showNotification(`‚úÖ Caricati ${allUnits.length} unit√†`, 'success');
                console.log('Dati caricati:', allUnits);
            } else {
                throw new Error('Formato dati non valido');
            }
        }
        

        // INVIO DATI con Google Forms - VERSIONE CORRETTA
        async function sendData(action, data, successMessage = 'Operazione completata') {
            showNotification('üì® Invio dati via Google Forms...', 'warning');   
            
            try {
                await sendViaGoogleForms(action, data);
                showNotification('‚úÖ ' + successMessage, 'success');
                
                // Ricarica i dati dopo 3 secondi
                setTimeout(loadAllData, 3000);
                return true;
                
            } catch (error) {
                showNotification('‚ùå Errore nell\'invio dati: ' + error.message, 'error');
                return false;
            }
        }

        async function sendViaGoogleForms(action, data) {
            return new Promise((resolve, reject) => {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = FORM_URL;
                form.target = 'hiddenFrame';
                form.style.display = 'none';

                // Crea dati leggibili per il form
                let formText = '';
                if (action === 'register') {
                    formText = `REGISTRAZIONE - Matricola: ${data.matricola}, Password: ${data.password}, Nick: ${data.nick}, Tipo: ${data.tipo}, Movimento: ${data.movimento}, Visione: ${data.visione}, Armatura: ${data.armatura}, Rifornimenti: ${data.rifornimenti}, Componenti: ${data.componenti}`;
                } else if (action === 'submitOrder') {
                    formText = `ORDINE - Matricola: ${data.matricola}, Tipo: ${data.tipoOrdine}, Dettagli: ${data.dettagli || ''}, Target: ${data.target || ''}, Quantit√†: ${data.quantit√† || ''}`;
                }

                const input = document.createElement('input');
                input.name = FORM_FIELD_ID; // ID CORRETTO!
                input.value = formText;
                form.appendChild(input);

                let iframe = document.getElementById('hiddenFrame');
                if (!iframe) {
                    iframe = document.createElement('iframe');
                    iframe.name = 'hiddenFrame';
                    iframe.id = 'hiddenFrame';
                    iframe.style.display = 'none';
                    document.body.appendChild(iframe);
                }

                iframe.onload = function() {
                    resolve(true);
                    setTimeout(() => {
                        if (form.parentNode) {
                            document.body.removeChild(form);
                        }
                    }, 1000);
                };

                document.body.appendChild(form);
                form.submit();

                setTimeout(() => resolve(true), 5000);
            });
        }

        // REGISTRAZIONE UNIT√Ä
        async function handleRegistration() {
            // Leggi tutti i valori dal form
            const matricola = document.getElementById('matricola').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const nick = document.getElementById('nick').value.trim();
            const tipo = document.getElementById('tipo').value;
            const movimento = document.getElementById('movimento').value;
            const visione = document.getElementById('visione').value;
            const armatura = document.getElementById('armatura').value;
            const rifornimenti = document.getElementById('rifornimenti').value;
            const componenti = document.getElementById('componenti').value.trim();
            
            // Validazione password
            if (password !== confirmPassword) {
                showNotification('Le password non coincidono', 'error');
                return;
            }
            
            if (!password) {
                showNotification('La password √® obbligatoria', 'error');
                return;
            }

            // Validazione matricola
            if (!matricola) {
                showNotification('La matricola √® obbligatoria', 'error');
                return;
            }
            
            if (allUnits.some(unit => unit.matricola === matricola)) {
                showNotification('Matricola gi√† esistente!', 'error');
                return;
            }

            // Validazione nick
            if (!nick) {
                showNotification('Il nickname √® obbligatorio', 'error');
                return;
            }
            
            if (allUnits.some(unit => unit.nick === nick)) {
                showNotification('Nickname gi√† registrato!', 'error');
                return;
            }
            
            // Validazione tipo
            if (!tipo) {
                showNotification('Il tipo unit√† √® obbligatorio', 'error');
                return;
            }
            
            // Prepara i dati - usa valori effettivi o 'N/A' solo se vuoti
            const unitData = {
                matricola: matricola,
                password: password,
                nick: nick,
                tipo: tipo,
                movimento: movimento ? parseInt(movimento) : 'N/A',
                visione: visione ? parseInt(visione) : 'N/A',
                armatura: armatura ? parseInt(armatura) : 'N/A',
                rifornimenti: rifornimenti ? parseInt(rifornimenti) : 'N/A',
                componenti: componenti
            };
            
            // Debug: mostra i valori che verranno inviati
            console.log('Dati unit√† da inviare:', unitData);
            
            await sendData('register', unitData, 'Unit√† registrata con successo!');
            document.getElementById('registrationForm').reset();
        }

        // [RIMANE TUTTO IL RESTO DEL CODICE COME PRIMA...]
        // GESTIONE UNIT√Ä, ORDINI, E FUNZIONI UTILITY
        function loadUnits() {
            const grid = document.getElementById('unitsGrid');
            
            if (allUnits.length === 0) {
                grid.innerHTML = '<div class="loading">Nessuna unit√† registrata</div>';
                return;
            }

            grid.innerHTML = '';
            allUnits.forEach(unit => {
                const card = document.createElement('div');
                card.className = `unit-card ${unit.approvata === 'SI' ? 'approved' : 'pending'}`;
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>${unit.matricola}</strong>
                        <span class="status status-${unit.approvata === 'SI' ? 'approved' : 'pending'}">
                            ${unit.approvata === 'SI' ? 'APPROVATA' : 'IN ATTESA'}
                        </span>
                    </div>
                    <div>üë§ ${unit.nick}</div>
                    <div>üéØ ${unit.tipo} | üìç ${unit.posizione}</div>
                    <div>üö∂ ${unit.movimento}m | üëÅÔ∏è ${unit.visione}m | üõ°Ô∏è ${unit.armatura}</div>
                    <div>üì¶ Rifornimenti: ${unit.rifornimenti}</div>
                    <div>üîß ${unit.componenti || 'Nessuno'}</div>
                `;
                
                grid.appendChild(card);
            });
        }

        function loadApprovedUnits() {
            const select = document.getElementById('orderUnit');
            select.innerHTML = '<option value="">Seleziona unit√† approvata...</option>';
            
            approvedUnits.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.matricola;
                option.textContent = `${unit.matricola} - ${unit.nick} (${unit.tipo})`;
                select.appendChild(option);
            });
        }

        async function verifyPassword() {
            const matricola = document.getElementById('orderUnit').value;
            const password = document.getElementById('unitPassword').value;
            const unit = allUnits.find(u => u.matricola === matricola);
            
            if (unit) {
                if (password === unit.password) {
                    document.getElementById('orderForm').style.display = 'block';
                    showNotification('‚úÖ Password corretta!', 'success');
                } else {
                    showNotification('‚ùå Password errata! ' + unit.password + password);
                    document.getElementById('orderForm').style.display = 'none';
                }
            }
        }

        function updateOrderDetails() {
            const detailsDiv = document.getElementById('orderDetails');
            const type = document.getElementById('orderType').value;
            
            let html = '';
            switch(type) {
                case 'muoversi':
                    html = `<div class="form-group"><label>Casella Destinazione *</label><input type="text" id="orderDestination" placeholder="Es: B2" required></div>`;
                    break;
                case 'salire':
                case 'scendere':
                    html = `<div class="form-group"><label>Posizione *</label><input type="text" id="orderPosition" placeholder="Es: C3" required></div>`;
                    break;
                case 'attivare':
                case 'ricaricare':
                    html = `<div class="form-group"><label>Nome Componente *</label><input type="text" id="orderComponent" placeholder="Es: Fucile" required></div>`;
                    break;
                case 'consumare':
                    html = `<div class="form-group"><label>Quantit√† Rifornimenti *</label><input type="number" id="orderQuantity" min="1" required></div>`;
                    break;
                case 'cedere':
                    html = `
                        <div class="form-group"><label>Unit√† Destinataria *</label>
                        <select id="orderTarget" required>
                            <option value="">Seleziona unit√†...</option>
                            ${approvedUnits.filter(u => u.matricola !== document.getElementById('orderUnit').value)
                                .map(u => `<option value="${u.matricola}">${u.matricola} - ${u.nick}</option>`).join('')}
                        </select></div>
                        <div class="form-group"><label>Quantit√† *</label><input type="number" id="orderQuantity" min="1" required></div>`;
                    break;
                case 'cura':
                    html = '<div class="form-group"><p>üíä Ordine di cura - nessun dettaglio aggiuntivo</p></div>';
                    break;
            }
            
            detailsDiv.innerHTML = html;
        }

        function addOrderToChain() {
            console.log('addOrderToChain called');
            try {
                const matricola = document.getElementById('orderUnit').value;
                const tipoOrdine = document.getElementById('orderType').value;
                
                console.log('Matricola:', matricola, 'Tipo Ordine:', tipoOrdine);
                
                if (!matricola || !tipoOrdine) {
                    showNotification('Seleziona unit√† e tipo ordine', 'error');
                    return;
                }
            
            const orderData = {
                matricola: matricola,
                tipoOrdine: tipoOrdine,
                dettagli: '',
                target: '',
                quantit√†: ''
            };
            
            // Validate and collect order details based on type
            let isValid = true;
            let errorMessage = '';
            
            switch(tipoOrdine) {
                case 'muoversi':
                    const destination = document.getElementById('orderDestination')?.value?.trim();
                    if (!destination) {
                        isValid = false;
                        errorMessage = 'Inserisci la casella destinazione';
                    } else {
                        orderData.dettagli = destination;
                    }
                    break;
                case 'salire':
                case 'scendere':
                    const position = document.getElementById('orderPosition')?.value?.trim();
                    if (!position) {
                        isValid = false;
                        errorMessage = 'Inserisci la posizione';
                    } else {
                        orderData.dettagli = position;
                    }
                    break;
                case 'attivare':
                case 'ricaricare':
                    const component = document.getElementById('orderComponent')?.value?.trim();
                    if (!component) {
                        isValid = false;
                        errorMessage = 'Inserisci il nome del componente';
                    } else {
                        orderData.dettagli = component;
                    }
                    break;
                case 'consumare':
                    const quantity = document.getElementById('orderQuantity')?.value?.trim();
                    if (!quantity || parseInt(quantity) <= 0) {
                        isValid = false;
                        errorMessage = 'Inserisci una quantit√† valida';
                    } else {
                        orderData.quantit√† = quantity;
                    }
                    break;
                case 'cedere':
                    const target = document.getElementById('orderTarget')?.value?.trim();
                    const cedeQuantity = document.getElementById('orderQuantity')?.value?.trim();
                    if (!target) {
                        isValid = false;
                        errorMessage = 'Seleziona l\'unit√† destinataria';
                    } else if (!cedeQuantity || parseInt(cedeQuantity) <= 0) {
                        isValid = false;
                        errorMessage = 'Inserisci una quantit√† valida';
                    } else {
                        orderData.target = target;
                        orderData.quantit√† = cedeQuantity;
                    }
                    break;
                case 'cura':
                    // No additional fields needed for cura
                    break;
            }
            
            if (!isValid) {
                showNotification(errorMessage, 'error');
                return;
            }
            
            currentOrders.push(orderData);
            updateOrderChainDisplay();
            updateStats();
            document.getElementById('orderChain').style.display = 'block';
            showNotification('Ordine aggiunto alla catena!', 'success');
            
            // Reset form
            document.getElementById('orderType').value = '';
            document.getElementById('orderDetails').innerHTML = '';
            } catch (error) {
                console.error('Errore in addOrderToChain:', error);
                showNotification('Errore: ' + error.message, 'error');
            }
        }

        function updateOrderChainDisplay() {
            const container = document.getElementById('orderItems');
            container.innerHTML = '';
            
            currentOrders.forEach((order, index) => {
                const item = document.createElement('div');
                item.className = 'order-item';
                item.innerHTML = `
                    <strong>${order.tipoOrdine}</strong> - ${order.matricola}
                    ${order.dettagli ? ` | ${order.dettagli}` : ''}
                    ${order.target ? ` ‚Üí ${order.target}` : ''}
                    ${order.quantit√† ? ` (${order.quantit√†})` : ''}
                    <button onclick="removeOrder(${index})" style="float: right; background: var(--danger); padding: 2px 8px; font-size: 0.8rem;">‚ùå</button>
                `;
                container.appendChild(item);
            });
        }

        function removeOrder(index) {
            currentOrders.splice(index, 1);
            updateOrderChainDisplay();
            updateStats();
            if (currentOrders.length === 0) {
                document.getElementById('orderChain').style.display = 'none';
            }
        }

        async function submitAllOrders() {
            if (currentOrders.length === 0) {
                showNotification('Nessun ordine da inviare', 'error');
                return;
            }
            
            showNotification(`üì® Invio ${currentOrders.length} ordini...`, 'warning');
            
            try {
                let successCount = 0;
                for (const order of currentOrders) {
                    const success = await sendData('submitOrder', order, '', false);
                    if (success) successCount++;
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Delay tra ordini
                }
                
                showNotification(`‚úÖ ${successCount}/${currentOrders.length} ordini inviati!`, 'success');
                currentOrders = [];
                document.getElementById('orderChain').style.display = 'none';
                updateStats();
                
            } catch (error) {
                showNotification('‚ùå Errore durante l\'invio degli ordini', 'error');
                console.error('Errore submitAllOrders:', error);
            }
        }

        function updateStats() {
            const total = allUnits.length;
            const approved = allUnits.filter(u => u.approvata === 'SI').length;
            const pending = total - approved;

            // Update elements only if they exist
            const totalUnitsEl = document.getElementById('totalUnits');
            if (totalUnitsEl) totalUnitsEl.textContent = total;
            
            const approvedUnitsEl = document.getElementById('approvedUnits');
            if (approvedUnitsEl) approvedUnitsEl.textContent = approved;
            
            const pendingUnitsEl = document.getElementById('pendingUnits');
            if (pendingUnitsEl) pendingUnitsEl.textContent = pending;

            const statsContainer = document.getElementById('statsContainer');
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${total}</div>
                        <div class="stat-label">Unit√° Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #27ae60;">${approved}</div>
                        <div class="stat-label">Approvate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #f39c12;">${pending}</div>
                        <div class="stat-label">In Attesa</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #3498db;">${currentOrders.length}</div>
                        <div class="stat-label">Ordini in Coda</div>
                    </div>
                `;
            }
        }

        function showNotification(message, type) {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }


    </script>

    <!-- IFRAME NECESSARIO -->
    <iframe name="hiddenFrame" id="hiddenFrame" style="display: none;"></iframe>
</body>
</html>